CODE=$(date +%s)

if ! test -e /proc/mdstat; then
    PRINT RAID+STATUS+NOTEXIST
elif grep -q "_" /proc/mdstat; then
    PRINT RAID+STATUS+DEGRADED+$CODE
    if ! test -e /dev/sda; then
        PRINT RAID+DIAGNOSE+$CODE+sda_MISSING
    elif ! test -e /dev/sdb; then
        PRINT RAID+DIAGNOSE+$CODE+sdb_MISSING
    elif grep -q "\(F\)" /proc/mdstat; then
        FAULTY=$(grep "\(F\)" /proc/mdstat)
        FAULTY=$(awk -F"\(F" APOSTROFO{print $1}APOSTROFO <<< $FAULTY|awk APOSTROFO{print $NF}APOSTROFO)
        FAULTY=$(sed -e "s/\[.*\]//" <<< $FAULTY)
        for FAULT in FAULTY; do
            PRINT RAID+DIAGNOSE+$CODE+${FAULTY}_FAULTY
        done
    else
        for MDSTAT in $(grep '_' /proc/mdstat|cut -db -f1);do
            if grep -B1 $MDSTAT /proc/mdstat|head -1|grep -q sda; then
                DISK=sdb
            else
                DISK=sda
            fi
            MD=$(grep -B1 $MDSTAT /proc/mdstat|head -1| cut -d\  -f1)
            PARTITION=$(grep -B1 $MDSTAT /proc/mdstat|head -1|sed -e "s/.*raid1 sd.\([0-9]\).*/\1/")
            if test -e /dev/$DISK$PARTITION ; then
                if grep -B1 $MDSTAT /proc/mdstat | grep -q recovery ; then
                    PRINT RAID+DIAGNOSE+$CODE+$DISK${PARTITION}_SYNCHRONIZING_RAID
                else
                    PRINT RAID+DIAGNOSE+$CODE+$DISK${PARTITION}_OUT_OF_RAID
                fi
            else
                PRINT RAID+DIAGNOSE+$CODE+$DISK${PARTITION}_MISSING
            fi
        done
    fi
else
    PRINT RAID+STATUS+OK
fi
